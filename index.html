<!DOCTYPE html>
<html>

<head>
     <meta http-equiv="content-type" content="text/html;charset=utf-8">
     <meta http-equiv="X-UA-Compatible" content="IE=Edge">
     <meta content="always" name="referrer">
     <meta name="theme-color" content="#2932e1">
     <title>电力项目</title>
     <!-- 引入 echarts.js -->
     <script src="js/echarts.min.js"></script>
     <script type="text/javascript" src="./bigdata/js/libs/dat.gui.min.js"></script>
     <script type="text/javascript" src="./bigdata/js/jquery-3.4.1.min.js"></script>
     <script src="js/socket.io.min.js"></script>
     <link rel="stylesheet" href="./css/yearAndTower.css">
     <style>
          p {
               color: white;
               text-align: right;
          }

          .title {
               /* background-image: url(./image/BTBJ.png); */
               background-repeat: no-repeat;
               color: white;
          }
     </style>
</head>
<!---->

<body style="background-image:url(./image/bj1.png);margin: 0px;padding: 0px;background-repeat: no-repeat">
     <!-- 标题 -->
     <div id="title"
          style="position: absolute;width: 702px;height:106px;float: left;left:1149px;top:0px;bottom: 0px;background-image:url(./image/title.png);">
     </div>
     <!-- <div id="titleOfProj">
         <div>
               <img src='./image/litimage/projtitle.png'>工程统计
         </div>
     </div> -->
     <!--年份与变电站数量对应表-->
     <div class="year">
          <div class="title">
               <div>
                    <img src='./image/litimage/projtitle.png'>
                    <p>工程统计</p>
              </div>
          </div>
          <div id="yearAndTower"></div>
     </div>
     <!--折单公里数-->
     <div class="zhedanshu">
          <div class="title">
               <div>
                    <img src='./image/litimage/zhedan.png'>
                    <p>折单公里统计</p>
              </div>
          </div>
          <div id="tongjitu"></div>
     </div>
     <!--200KV\500KV变电站-->
     <div class="constructor">
          <!--220kV变电站所对应的百分比-->
          <div class="touchan">
               <div id="touchan"></div>
               <div class="gongcheng">新建工程</div>
          </div>
          <!--550KV变电站所对应的百分比-->
          <div class="sheji">
               <div id="sheji"></div>
               <div class="gongcheng">扩建工程</div>
          </div>
     </div>
     <!--区域数据排行榜-->
     <div class="top">
          <div class="title">
               <div>
                    <img src='./image/litimage/top.png'>
                    <p>主变容量统计</p>
              </div>
          </div>
          <!-- <div id="top5"></div> -->
          <div class="eight">
               <div id="top0" class="topeight" >
                   <div>
                         <p class="area">江北区</p>
                         <span class="projNum">~ 工程数量：56</span>
                         <span class="towerNum">~ 变电站：129</span>
                   </div>
                    
               </div>
               <div id="top1" class="topeight">
                    <div>
                         <p class="area">江北区</p>
                         <span class="projNum">~ 工程数量：56</span>
                         <span class="towerNum">~ 变电站：129</span>
                   </div>
               </div>
               <div id="top2" class="topeight">
                    <div>
                         <p class="area">江北区</p>
                         <span class="projNum">~ 工程数量：56</span>
                         <span class="towerNum">~ 变电站：129</span>
                   </div>
               </div>
               <div id="top3" class="topeight">
                    <div>
                         <p class="area">江北区</p>
                         <span class="projNum">~ 工程数量：56</span>
                         <span class="towerNum">~ 变电站：129</span>
                   </div>
               </div>
               <div id="top4" class="topeight">
                    <div>
                         <p class="area">江北区</p>
                         <span class="projNum">~ 工程数量：56</span>
                         <span class="towerNum">~ 变电站：129</span>
                   </div>
               </div>
               <div id="top5" class="topeight">
                    <div>
                         <p class="area">江北区</p>
                         <span class="projNum">~ 工程数量：56</span>
                         <span class="towerNum">~ 变电站：129</span>
                   </div>
               </div>
               <div id="top6" class="topeight">
                    <div>
                         <p class="area">江北区</p>
                         <span class="projNum">~ 工程数量：56</span>
                         <span class="towerNum">~ 变电站：129</span>
                   </div>
               </div>
               <div id="top7" class="topeight">
                    <div>
                         <p class="area">江北区</p>
                         <span class="projNum">~ 工程数量：56</span>
                         <span class="towerNum">~ 变电站：129</span>
                   </div>
               </div>
          </div>
     </div>
     <div class="rightMiddle">
          <div id='bg'></div>
          <div id='fiveArea'>
               <div class="line">
                   <div>
                         <p>巴南区</p>
                         <p>120</p>
                         <p>km</p>
                   </div>
               </div>
               <div class="line">
                    <div>
                         <p>巴南区</p>
                         <p>120</p>
                         <p>km</p>
                   </div>
               </div>
               <div class="line">
                    <div>
                         <p>巴南区</p>
                         <p>120</p>
                         <p>km</p>
                   </div>
               </div>
               <div class="line">
                    <div>
                         <p>巴南区</p>
                         <p>120</p>
                         <p>km</p>
                   </div>
               </div>
               <div class="line">
                    <div>
                         <p>巴南区</p>
                         <p>120</p>
                         <p>km</p>
                   </div>
               </div>
          </div>
     </div>
     <div id='middle'>
          <div id="totalTower">变电站总数:141个</div>
          <div id='totalKm'>折单公里数:7304km</div>
     </div>

     <!-- 主变容量 -->
     <div class="mainpower">
          <div class="title">
               <div>
                    <img src='./image/litimage/mainPower.png'>
                    <p>主变容量统计</p>
              </div>
          </div>
          <div id="tongJi1"></div>
     </div>
     <script id="post-vert-2" type="x-shader/x-vertex">
          //摄像机景深效果
                     varying vec2 vUv;
      
                     void main() {
                          vUv = uv;
                          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                     }
     </script>
     <script id="post-frag-2" type="x-shader/x-fragment">
          varying vec2 vUv;
                     uniform sampler2D tColor;
                     uniform float textureWidth;
                     uniform float textureHeight;
      
                     float getWeight(float dist, float maxDist){
                          return 1.0 - dist/maxDist;
                     }
      
                     void main() {
                          vec3 blurColor = vec3(0.0);
                          float coc = 0.0;
                          const int cocBlurSize = 8;
                          float cocBlurSizef = float(cocBlurSize);
                          const int bokehBlurSize = 8;
                          float bokehBlurSizef = float(bokehBlurSize);
                          vec2 textureRatio = vec2(1.0/textureWidth, 1.0/textureHeight);
                          vec3 sourceColor = texture2D(tColor, vUv).rgb;
      
                          // blur the coc
                          float cocBlurWeightTotal = 0.0;
                          for(int i=-cocBlurSize; i<cocBlurSize; i++)
                              for(int j=-cocBlurSize; j<cocBlurSize; j++)
                              {
                                         vec2 dir =  vec2(i, j) * textureRatio;
                                         float dist = length(dir);
                                         if(dist > cocBlurSizef)
                                              continue;
                                         float weight = 1.0; // getWeight(dist, cocBlurSizef);
                                         cocBlurWeightTotal += weight;
                                         vec2 curUv = dir + vUv;
                                         coc += weight * texture2D(tColor, curUv).a;
                                    }
                          coc /= cocBlurWeightTotal;
                          float originalCoc = texture2D(tColor, vUv).a;
      
                          // according to https://developer.nvidia.com/gpugems/GPUGems3/gpugems3_ch28.html
                          coc = 2.0 * max(originalCoc, coc) - originalCoc;
      
      
                          float bokehBlurWeightTotal = 0.0;
                          if (coc > 1e-5)
                          {
                               for(int i=-bokehBlurSize; i<bokehBlurSize; i++)
                                    for(int j=-bokehBlurSize; j<bokehBlurSize; j++)
                                    {
                                         vec2 dir = vec2(i, j) * textureRatio;  // can optimize
                                         float dist = length(dir);
                                         if(dist > bokehBlurSizef)
                                              continue;
                                         vec2 curUv = dir + vUv;
                                         float weight = getWeight(dist, bokehBlurSizef);
                                         bokehBlurWeightTotal += weight;
                                         blurColor +=  weight * texture2D(tColor, curUv).rgb;
                                    }
                               blurColor /= bokehBlurWeightTotal;
      
                               gl_FragColor.rgb = mix(sourceColor, blurColor, coc);
                          }
                          else
                          {
                               gl_FragColor.rgb = sourceColor;
                          }
                          gl_FragColor.a = 1.0;
                     }
     </script>

     <script id="post-vert-1" type="x-shader/x-vertex">
          varying vec2 vUv;
      
                     void main() {
                          vUv = uv;
                          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                     }
     </script>
     <script id="post-frag-1" type="x-shader/x-fragment">
          #include <packing>
      
                      varying vec2 vUv;
                      uniform sampler2D tColor;
                      uniform sampler2D tDepth;
                      uniform float cameraNear;
                      uniform float cameraFar;
                      uniform float focalDepth;
                      uniform float farStart;
                      uniform float farRange;
                      uniform float nearStart;
                      uniform float nearRange;
                      uniform float textureWidth;
                      uniform float textureHeight;
      
                      const int circleSize = 4;		//模糊数值
      
                      float readDepth( sampler2D depthSampler, vec2 coord ) {
                          float fragCoordZ = texture2D( depthSampler, coord ).x;
                          float viewZ = perspectiveDepthToViewZ( fragCoordZ, cameraNear, cameraFar );
                          return viewZ;
                          }
      
                          float getWeight(float dist, float maxDist){
                               return 1.0 - dist/maxDist;
                          }
      
                      vec3 getColorBlur(vec2 uv){
                          vec2 curUv;
                          vec3 color = vec3(0.0, 0.0, 0.0);
                          vec2 textureRatio = vec2(1.0/textureWidth, 1.0/textureHeight);
                               float weightTotal = 0.0;
                               float circleSizef = float(circleSize);
                          for(int i=-circleSize; i<circleSize; i++)
                              for(int j=-circleSize; j<circleSize; j++)
                              {
                                         vec2 dir =  vec2(i, j) * textureRatio;
                                         float dist = length(dir);
                                  if(dist > float(circleSize))
                                      continue;
                                  curUv = uv + dir;
                                  float depth = readDepth(tDepth, curUv);
      
                                         // background should not mix foregournd in this pass
                                  if((-depth - focalDepth - farStart < 0.0))
                                       continue;
      
                                         float weight = getWeight(dist, circleSizef);
                                  color += weight * texture2D( tColor, curUv ).rgb;
                                  weightTotal += getWeight(dist, circleSizef);
                              }
                          return color * (1.0 / weightTotal);
                      }
      
                      void main() {
                          vec3 color = texture2D( tColor, vUv ).rgb;
                          float depth = readDepth( tDepth, vUv );
      
                          float depthVal =  -depth - focalDepth;
                          float coc = 0.0;
      
                          if(depthVal < 0.0)
                          {
                              coc = (-depthVal - nearStart) / nearRange;
                          }
                          else
                          {
                              coc = (depthVal - farStart) / farRange;
                          }
      
                          coc = clamp(coc, 0.0, 1.0);
                               bool isForeGroundOrFocus = -depth - (focalDepth + farStart) < 0.0;
      
                               // this shader only handle background.
                               //  "a" channel stores the coc value.
                               if(isForeGroundOrFocus)
                               {
                                    gl_FragColor.rgb = color;
                                    gl_FragColor.a = coc;
                               }
                               else
                               {
                                    vec3 colorBlur = getColorBlur(vUv);
                                    vec3 colorMix = mix(color, colorBlur, coc);
                                    gl_FragColor.rgb = vec3(colorMix);
                               }
      
                      }
     </script>

     <script type="module">
          import { Datas } from './bigdata/Datas.js'
          import { MapChina3d } from './bigdata/MapChina3d.js'
          import { addChart } from './js/addChart.js'
          if (typeof module === 'object') {
               window.jQuery = window.$ = module.exports;
          };
          //年份对应220kv，500kv工程数初始状态
          let yearData = ['05', '06', '07', '08', '09', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19'];
          let typeOf220 = [10, 14, 13, 8, 9, 9, 17, 8, 14, 13, 11, 12, 16, 10,10];
          let typeOfTotal =  [9, 14, 9, 5, 7, 8, 14, 6, 14, 10, 9, 9, 10, 10,6];
          let typeOf500 =  [1, 0, 4, 3, 2, 1, 3, 2, 0, 3, 2, 3, 6, 0,4];

          //每年对应的折单公里数
          let xAxisData =  ['05', '06', '07', '08', '09', '10', 11, 12, 13, 14, 15, 16, 17, 18, 19, 'total'];
          let year =  ['05', '06', '07', '08', '09', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19'];
          let totalKm = [0, 631, 1165, 2353, 2459, 3026, 3566, 4334, 4556, 5178, 5504, 5916, 6361, 7025, 7181, 0];
          // let everyKm = [631, 534, 1188, 106, 567, 540, 768, 222, 622, 326, 412, 445, 664, 156,143, 7324]
          let everyKm = [631, 534, 1188, 106, 567, 540, 768, 222, 622, 326, 412, 445, 664, 156,143];
          //连接服务器
          connectionServer();
          addChart.init();
          //连接服务器  
          function connectionServer() {
               var namespace = "/";
               window.appname = "html";
               window.serverURL = "ws://192.168.22.55:3001" + namespace;
               try {
                    var scoket = io.connect(window.serverURL);
                    window.mysocket = scoket;
                    scoket.on("connect", function () {
                         window.mysocket.emit("login", {
                              appname: window.appname
                         });
                    });
               } catch (err) {
                    console.log("err");
               }
          }
          //统计05年到19年每年修建的220KV与500Kv工程的数量
          var _map;
          init();
          function init()
          {
          //  Datas._gui = new dat.GUI();
            _map = new MapChina3d();
			_map.init2();
			// setTimeout(()=>{
			// 	_map.areaSelectHandler("face_yubei");
			// },10000)

          }
          window.mysocket.on('dianjian',(msg)=>{
               //_map.createMapLab([1000,300] , msg , msg,234,1042)
               _map.areaSelectHandler("face_"+msg);
              // addChart.hide('.year');
               // setTimeout(()=>{
               //      addChart.show('.year');
               // },5000)
               addChart.showNum(120,1203);
              
           })
           //用来设置年份与220kv，500kv工程数
           window.mysocket.on('dianjianYearOfProj',(msg)=>{
                         addChart.hide('.year');
                         addChart.yearAndTowerOption.xAxis.data = msg.year;
                         let totalArr = getArr( msg.num220,msg.num500);
                         addChart.yearAndTowerOption.series[0].data =  totalArr;
                         addChart.yearAndTowerOption.series[1].data =  msg.num220
                         addChart.yearAndTowerOption.series[2].data = msg.num500;
                         addChart.setOption(addChart.yearAndTowerOption, 'yearAndTower');
                         addChart.show('.year');

                         //设置每年的折单公里数
                         addChart.hide('.zhedanshu');
                         let cloneArr = msg.year.concat();
                         cloneArr.push('total')
                         addChart.unilatKeralKilometreOption.xAxis.data = cloneArr;
                         console.log(newArr(everyKm));
                         addChart.unilatKeralKilometreOption.series[0].data = newArr(msg.km);
                         addChart.unilatKeralKilometreOption.series[1].data = sum(msg.km);
                         addChart.setOption(addChart.unilatKeralKilometreOption, 'tongjitu');
                         // addChart.yearAndTowerOption.xAxis.data = msg.year;
                         // let totalArr = getArr( msg.num220,msg.num500);
                         // addChart.yearAndTowerOption.series[0].data =  totalArr;
                         // addChart.yearAndTowerOption.series[1].data =  msg.num220
                         // addChart.yearAndTowerOption.series[2].data = msg.num500;
                         // addChart.setOption(addChart.yearAndTowerOption, 'yearAndTower');
                         addChart.show('.zhedanshu');
                        
           })
           window.mysocket.on('dianjianCapacity',(msg)=>{
                         addChart.hide('.mainpower');

                         addChart.touchangZhuBianOption.xAxis.data = msg.type;
                         addChart.touchangZhuBianOption.series[0].data =  msg.num;
                         addChart.setOption(addChart.touchangZhuBianOption, 'tongJi1');
                         addChart.show('.mainpower')
           })
           window.mysocket.on('dianjianState',(msg)=>{
                         addChart.hide('.constructor');
                         addChart.show('.constructor')
                         addChart.showConstructor('touchan',msg);
                         addChart.showConstructor('sheji',msg.reverse());
                        
           })
           window.mysocket.on('dianjianKm',(msg)=>{
                         addChart.hide('.zhedanshu');
                         addChart.show('.zhedanshu');
                         addChart.unilatKeralKilometreOption.xAxis.data('touchan',msg);
                         addChart.showConstructor('sheji',msg.reverse());
                        
           })
          
           //求数组的和并加入数组
           function sum(arr){
               let newArr = arr.concat();
               let sum =  newArr.reduce((sum1,value)=>{
                   return sum1+value;
              },0);
              newArr.push(sum);
              return newArr;
          }
          //放回一个新数组，此数组数为原数组两两相加
          function newArr(arr){
               let newArray = [];
               let total = 0;
               newArray.push(total);
               for (let index = 0; index < arr.length; index++) {
                    const element = arr[index];
                    total += element;
                    newArray.push(total);
               }
               newArray = newArray.splice(0,newArray.length-1);
               newArray.push(0);
               return newArray;
          }
          
           function getArr(arr1,arr2){
               let totalArr = [];
               for (let index = 0; index < arr1.length; index++) {
                    const element1 = arr1[index];
                    const element2 = arr2[index];
                    let element  = element1+element2;
                    totalArr.push(element)
                    
               }
               return totalArr;
           }
          //通过数组设置每个区域的背景图片
          // function setBgImgByArr(arr){
          //      for (let index = 0; index < arr.length; index++) {
          //           const element = arr[index];
          //           addChart.showProvice(top+index,'url');
          //      }
          // }
     </script>
</body>

</html>